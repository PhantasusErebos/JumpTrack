<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JumpTrack Chain Print</title>
    <link rel="stylesheet" href="print.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=JetBrains+Mono:wght@400&family=Cormorant+Garamond:wght@400;600;700&display=swap"
        rel="stylesheet">
</head>

<body>

    <div class="print-controls">
        <button onclick="window.print()">üñ®Ô∏è Print / Save as PDF</button>
        <button onclick="window.close()">Close</button>
    </div>

    <div class="document-container">
        <header class="main-header">
            <h1 id="jumper-name-header">Jumper's Chain</h1>
            <div class="chain-meta">
                <span>Total Jumps: <b id="total-jumps">0</b></span>
            </div>
        </header>

        <div id="content-body">
            <!-- Jumps will be injected here -->
        </div>

        <footer class="doc-footer">
            Generated by JumpTrack
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const rawData = localStorage.getItem('jumpTrack_printData');
            if (!rawData) {
                document.body.innerHTML = '<h1>No data found. Please return to the app and try again.</h1>';
                return;
            }

            const jumper = JSON.parse(rawData);
            document.title = `${jumper.name || 'Jumper'} - JumpChain Record`;
            document.getElementById('jumper-name-header').textContent = `${jumper.name || 'Jumper'}'s Chain`;
            document.getElementById('total-jumps').textContent = jumper.jumps.length;

            const container = document.getElementById('content-body');

            // Helper to create sections
            function createSection(parent, title, items, type) {
                if (!items || items.length === 0) return;

                const section = document.createElement('section');
                section.className = 'doc-section';

                const h3 = document.createElement('h3');
                h3.textContent = title;
                section.appendChild(h3);

                const grid = document.createElement('div');
                grid.className = 'item-grid';

                items.forEach(item => {
                    const card = document.createElement('div');
                    card.className = `item-card type-${type}`;

                    const header = document.createElement('div');
                    header.className = 'item-header';

                    const name = document.createElement('span');
                    name.className = 'item-name';
                    name.textContent = item.name || 'Untitled';

                    header.appendChild(name);

                    if (item.cost !== undefined || item.rewardValue !== undefined) {
                        const cost = document.createElement('span');
                        cost.className = 'item-cost';
                        if (type === 'scenario') {
                            cost.textContent = `+${item.rewardValue} CP`;
                            cost.classList.add('gain');
                        } else {
                            cost.textContent = `${item.cost} CP`;
                        }
                        header.appendChild(cost);
                    }

                    card.appendChild(header);

                    if (item.description) {
                        const desc = document.createElement('div');
                        desc.className = 'item-description';
                        desc.textContent = item.description;
                        card.appendChild(desc);
                    }

                    if (type === 'scenario' && item.rewardDescription) {
                        const reward = document.createElement('div');
                        reward.className = 'item-reward';
                        reward.innerHTML = `<strong>Reward:</strong> ${item.rewardDescription}`;
                        card.appendChild(reward);
                    }

                    grid.appendChild(card);
                });

                section.appendChild(grid);
                parent.appendChild(section);
            }

            function renderBuild(parent, build, charName) {
                const charSection = document.createElement('div');
                charSection.className = 'character-section';

                const header = document.createElement('div');
                header.className = 'character-header';
                header.innerHTML = `
                    <span class="char-name">${charName}</span>
                    <div class="char-meta">
                        <span>Origin: <b>${build.origin || 'None'}</b></span>
                        <span>Budget: <b>${build.budget || 0} CP</b></span>
                    </div>
                `;
                charSection.appendChild(header);

                if (build.originDescription) {
                    const desc = document.createElement('div');
                    desc.className = 'origin-description';
                    desc.textContent = build.originDescription;
                    charSection.appendChild(desc);
                }

                createSection(charSection, 'Perks', build.perks, 'perk');
                createSection(charSection, 'Items', build.items, 'item');
                createSection(charSection, 'Companions', build.companions, 'companion');
                createSection(charSection, 'Drawbacks', build.drawbacks, 'drawback');
                createSection(charSection, 'Scenarios', build.scenarios, 'scenario');
                createSection(charSection, 'Events & Logs', build.logs, 'event');
                createSection(charSection, 'Alt Forms', build.altForms, 'altform');
                createSection(charSection, 'Notes', build.notes, 'note');

                parent.appendChild(charSection);
            }

            // Split Supplements and Jumps
            const supplements = jumper.jumps.filter(j => j.type === 'supplement');
            const jumps = jumper.jumps.filter(j => j.type !== 'supplement');

            function renderJumpItem(jump, index, isSupplement) {
                const jumpContainer = document.createElement('article');
                jumpContainer.className = 'jump-container';

                const jumpHeader = document.createElement('header');
                jumpHeader.className = 'jump-header';

                const prefix = isSupplement ? 'Supplement' : `Jump #${index + 1}`;
                jumpHeader.innerHTML = `<h2><span class="jump-number">${prefix}</span> ${jump.name || 'Untitled'}</h2>`;

                jumpContainer.appendChild(jumpHeader);

                // 1. Jumper Build
                renderBuild(jumpContainer, jump, jumper.name || 'Jumper');

                // 2. Companion Builds
                if (jump.companionBuilds) {
                    Object.keys(jump.companionBuilds).forEach(compId => {
                        const build = jump.companionBuilds[compId];
                        const comp = jumper.companions.find(c => c.id === compId);
                        const compName = comp ? comp.name : 'Unknown Companion';

                        renderBuild(jumpContainer, build, compName);
                    });
                }

                container.appendChild(jumpContainer);
            }

            // Render Supplements
            if (supplements.length > 0) {
                const suppHeader = document.createElement('h2');
                suppHeader.textContent = "Supplements";
                suppHeader.style.textAlign = 'center';
                suppHeader.style.marginTop = '40px';
                suppHeader.style.borderBottom = '2px solid #ccc';
                container.appendChild(suppHeader);

                supplements.forEach((jump, index) => renderJumpItem(jump, index, true));
            }

            // Render Jumps
            if (jumps.length > 0) {
                const jumpHeader = document.createElement('h2');
                jumpHeader.textContent = "Jump Chain";
                jumpHeader.style.textAlign = 'center';
                jumpHeader.style.marginTop = '40px';
                jumpHeader.style.borderBottom = '2px solid #ccc';
                container.appendChild(jumpHeader);

                jumps.forEach((jump, index) => renderJumpItem(jump, index, false));
            }

        });
    </script>
</body>

</html>